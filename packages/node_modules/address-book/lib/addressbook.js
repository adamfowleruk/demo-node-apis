const express = require('express')
const hateoasLinker = require('express-hateoas-links');

const app = express()
const port = process.env.PORT || 3000

var addresses = [
  {"forename": "Adam", "surname": "Fowler", "number": "555-123-456"},
  {"forename": "Leo", "surname": "Fowler", "number": "555-123-444"},
  {"forename": "Zack", "surname": "Fowler", "number": "555-123-666"},
  {"forename": "Jess", "surname": "Williams", "number": "555-123-777"},
]



module.exports = {
  start: function (settings) {

    // replace standard express res.json with the new version
    app.use(hateoasLinker);

    app.get('/', (req, res) => {

      // create an example JSON Schema
      var addressSchema = {
        "name": "Address",
        "description": "This JSON Schema defines the parameters required to create an Address object",
        "properties": {
            "forename": {
                "title": "Forename",
                "description": "Please enter your forename",
                "type": "string",
                "maxLength": 30,
                "minLength": 1,
                "required": true
            },
            "surname": {
                "title": "Surname",
                "type": "string"
            },
            "number": {
                "title": "Telephone Number",
                "description": "Please enter telephone number",
                "type": "string",
                "required": true
            }
          }
      };
    
      res.json(personSchema, [
          {rel: "self", method: "GET", href: "/"},
          {rel: "list", method: "GET", href: "/list"},
          {rel: "create", method: "PUT", href: "/"}
        ]
      )
    })

    app.get('/list', (req, res) => {
      var addressesOut = []
      for (var i = 0;i < addresses.length; i++) {
        addressesOut.push({
          "addressId": i,
          "forename": addresses[i].forename,
          "surname": addresses[i].surname,
          "number": addresses[i].number,
          "links": {
            "view": "/addresses/" + i,
            "edit": "/addresses/" + i + "/update",
            "delete": "/addresses/" + i + "/delete"
          }
        })
      }

      res.json({
        "address-count": addresses.length,
        "addresses" : addresses
      }, [
        {rel: "self", method: "GET", href: "/list"}
      ])
    })

    app.put('/', (req, res) => {
      addresses.push(req.json)

      res.json({"success": true}, [
        {rel: "self", method: "GET", href: "/" + addresses.length},
        {rel: "addresses", method: "GET", href: "/"},
        {rel: "list", method: "GET", href: "/list"},
      ])
    })

    app.listen(settings.apiPort, () => {
      console.log(`Address book listening at http://localhost:${port}`)
    })

  }
};